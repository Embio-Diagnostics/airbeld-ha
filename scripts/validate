#!/usr/bin/env bash
#
# Local validation script for Airbeld integration
# Performs basic checks before pushing to GitHub
#

set -e

cd "$(dirname "$0")/.."

INTEGRATION_PATH="custom_components/airbeld"

echo "üîç Running local validation checks..."
echo ""

# Check 1: Validate manifest.json syntax
echo "Checking manifest.json..."
if ! python3 -m json.tool "$INTEGRATION_PATH/manifest.json" > /dev/null 2>&1; then
    echo "‚ùå Invalid manifest.json syntax"
    exit 1
fi
echo "‚úÖ manifest.json is valid JSON"

# Check 2: Validate strings.json syntax
echo "Checking strings.json..."
if ! python3 -m json.tool "$INTEGRATION_PATH/strings.json" > /dev/null 2>&1; then
    echo "‚ùå Invalid strings.json syntax"
    exit 1
fi
echo "‚úÖ strings.json is valid JSON"

# Check 3: Validate translations/en.json syntax
echo "Checking translations/en.json..."
if ! python3 -m json.tool "$INTEGRATION_PATH/translations/en.json" > /dev/null 2>&1; then
    echo "‚ùå Invalid translations/en.json syntax"
    exit 1
fi
echo "‚úÖ translations/en.json is valid JSON"

# Check 4: Required files exist
echo "Checking required files..."
REQUIRED_FILES=(
    "$INTEGRATION_PATH/__init__.py"
    "$INTEGRATION_PATH/manifest.json"
    "$INTEGRATION_PATH/strings.json"
    "$INTEGRATION_PATH/translations/en.json"
)

for file in "${REQUIRED_FILES[@]}"; do
    if [[ ! -f "$file" ]]; then
        echo "‚ùå Missing required file: $file"
        exit 1
    fi
done
echo "‚úÖ All required files present"

# Check 5: Manifest has required fields
echo "Checking manifest required fields..."
MANIFEST=$(cat "$INTEGRATION_PATH/manifest.json")
REQUIRED_FIELDS=("domain" "name" "version" "documentation" "requirements" "codeowners" "iot_class")

for field in "${REQUIRED_FIELDS[@]}"; do
    if ! echo "$MANIFEST" | python3 -c "import sys, json; data=json.load(sys.stdin); sys.exit(0 if '$field' in data else 1)" 2>/dev/null; then
        echo "‚ùå Missing required field in manifest.json: $field"
        exit 1
    fi
done
echo "‚úÖ All required manifest fields present"

echo ""
echo "‚úÖ Local validation passed!"
echo ""
echo "Note: Full hassfest and HACS validation run on GitHub Actions."
echo "      Push your changes to see complete validation results."
echo ""
echo "Run both checks with: ./scripts/lint && ./scripts/validate"
